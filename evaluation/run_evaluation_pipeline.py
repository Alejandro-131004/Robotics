# -*- coding: utf-8 -*-
"""Código para run_evaluation_pipeline.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fw_ywYA5lEnPiWKat0Hk4nu79vv4pyU2
"""

import os
import sys

# Ajustar sys.path se necessário para módulos do controlador Webots
# sys.path = [p for p in sys.path if 'controller' not in p]
# sys.path.insert(0, '/Applications/Webots.app/Contents/lib/controller/python') # Ajuste o caminho se necessário

from controller import Supervisor

# Importar as funções dos novos ficheiros
from map_generator import generate_maps
from model_evaluator import evaluate_models

from environment.configuration import MAX_DIFFICULTY_STAGE

if __name__ == "__main__":
    print("--- Pipeline de Avaliação de Modelos Iniciada ---")

    # --- 1. Configurações da Geração de Mapas ---
    MAPS_OUTPUT_DIR = "evaluation/maps"
    NUM_MAPS_PER_DIFFICULTY = 100 # Total de 1000 mapas (100 * 10 dificuldades)
    TOTAL_DIFFICULTY_STAGES = int(MAX_DIFFICULTY_STAGE) # Assumindo 10 estágios como no seu config.py

    # --- 2. Configurações da Avaliação de Modelos ---
    # Solicitar ao utilizador a pasta dos modelos
    model_folder_input = input("Por favor, insira o caminho para a pasta dos seus modelos guardados (ex: saved_models): ")
    MODEL_FOLDER = model_folder_input.strip()

    if not os.path.isdir(MODEL_FOLDER):
        print(f"[ERRO] A pasta de modelos '{MODEL_FOLDER}' não foi encontrada. Por favor, verifique o caminho e tente novamente.")
        sys.exit(1) # Sair se a pasta não existir

    RESULTS_OUTPUT_DIR = "evaluation/results" # Onde os gráficos e resumos serão guardados

    print("Iniciando Supervisor Webots para a pipeline de avaliação...")
    # O Supervisor precisa de ser instanciado uma única vez no início da pipeline
    # e passado para as funções que interagem com o Webots.
    supervisor = Supervisor()

    # --- Etapa 1: Gerar os mapas de teste ---
    generated_map_files = generate_maps(
        maps_output_dir=MAPS_OUTPUT_DIR,
        num_maps_per_difficulty=NUM_MAPS_PER_DIFFICULTY,
        total_difficulty_stages=TOTAL_DIFFICULTY_STAGES
    )

    if not generated_map_files:
        print("[AVISO] Nenhuns mapas foram gerados. A avaliação não pode prosseguir.")
        sys.exit(0)

    # --- Etapa 2: Avaliar os modelos nos mapas gerados ---
    evaluate_models(
        supervisor=supervisor, # Passar a instância do supervisor
        model_folder=MODEL_FOLDER,
        map_files=generated_map_files,
        results_output_dir=RESULTS_OUTPUT_DIR
    )

    print("\n--- Pipeline de Avaliação de Modelos Concluída ---")
    # Não chamamos supervisor.simulationQuit(0) aqui para que o utilizador possa inspecionar o Webots
    # se desejar, mas pode ser adicionado se preferir que saia automaticamente.